<!DOCTYPE html><html lang="en"><head><title>src/session</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="src/session"><meta name="groc-project-path" content="src/session.coffee"><meta name="groc-github-url" content="https://github.com/xdissent/iosctrl"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/xdissent/iosctrl/blob/master/src/session.coffee">src/session.coffee</a></div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="nv">$ = </span><span class="nx">require</span> <span class="s">&#39;NodObjC&#39;</span>
<span class="nv">debug = </span><span class="nx">require</span><span class="p">(</span><span class="s">&#39;debug&#39;</span><span class="p">)</span> <span class="s">&#39;iosctrl:session&#39;</span>
<span class="nx">require</span> <span class="s">&#39;./frameworks&#39;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Create the Session ObjC class.</p></div></div><div class="code"><div class="wrapper"><span class="nv">module.exports = Session = </span><span class="nx">$</span><span class="p">.</span><span class="nx">NSObject</span><span class="p">.</span><span class="nx">extend</span> <span class="s">&#39;Session&#39;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Add ivars to the Session class.</p></div></div><div class="code"><div class="wrapper"><span class="nx">Session</span><span class="p">.</span><span class="nx">addIvar</span> <span class="s">&#39;session&#39;</span><span class="p">,</span> <span class="s">&#39;@&#39;</span>
<span class="nx">Session</span><span class="p">.</span><span class="nx">addIvar</span> <span class="s">&#39;app&#39;</span><span class="p">,</span> <span class="s">&#39;@&#39;</span>
<span class="nx">Session</span><span class="p">.</span><span class="nx">addIvar</span> <span class="s">&#39;sys&#39;</span><span class="p">,</span> <span class="s">&#39;@&#39;</span>
<span class="nx">Session</span><span class="p">.</span><span class="nx">addIvar</span> <span class="s">&#39;env&#39;</span><span class="p">,</span> <span class="s">&#39;@&#39;</span>
<span class="nx">Session</span><span class="p">.</span><span class="nx">addIvar</span> <span class="s">&#39;args&#39;</span><span class="p">,</span> <span class="s">&#39;@&#39;</span>
<span class="nx">Session</span><span class="p">.</span><span class="nx">addIvar</span> <span class="s">&#39;err&#39;</span><span class="p">,</span> <span class="s">&#39;@&#39;</span>
<span class="nx">Session</span><span class="p">.</span><span class="nx">addIvar</span> <span class="s">&#39;out&#39;</span><span class="p">,</span> <span class="s">&#39;@&#39;</span>
<span class="nx">Session</span><span class="p">.</span><span class="nx">addIvar</span> <span class="s">&#39;family&#39;</span><span class="p">,</span> <span class="s">&#39;@&#39;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Add the <code>stop</code> method to the Session class.</p></div></div><div class="code"><div class="wrapper"><span class="nx">Session</span><span class="p">.</span><span class="nx">addMethod</span> <span class="s">&#39;stop&#39;</span><span class="p">,</span> <span class="s">&#39;v@:&#39;</span><span class="p">,</span> <span class="nf">(self) -&gt;</span>
  <span class="nx">debug</span> <span class="s">&quot;stop&quot;</span>
  <span class="nx">self</span><span class="p">.</span><span class="nx">ivar</span><span class="p">(</span><span class="s">&#39;session&#39;</span><span class="p">)</span> <span class="s">&#39;requestEndWithTimeout&#39;</span><span class="p">,</span> <span class="mi">10</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Add the <code>start</code> method to the Session class.</p></div></div><div class="code"><div class="wrapper"><span class="nx">Session</span><span class="p">.</span><span class="nx">addMethod</span> <span class="s">&#39;start&#39;</span><span class="p">,</span> <span class="s">&#39;v@:&#39;</span><span class="p">,</span> <span class="nf">(self) -&gt;</span>
  <span class="nx">debug</span> <span class="s">&quot;start&quot;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Initialize variables for the simulator config.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">app = </span><span class="nx">$</span><span class="p">.</span><span class="nx">DTiPhoneSimulatorApplicationSpecifier</span> <span class="s">&#39;specifierWithApplicationPath&#39;</span><span class="p">,</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">ivar</span> <span class="s">&#39;app&#39;</span>
  <span class="nv">sys = </span><span class="nx">self</span><span class="p">.</span><span class="nx">ivar</span><span class="p">(</span><span class="s">&#39;sys&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="nx">$</span><span class="p">.</span><span class="nx">DTiPhoneSimulatorSystemRoot</span> <span class="s">&#39;defaultRoot&#39;</span>
  <span class="nv">env = </span><span class="nx">self</span><span class="p">.</span><span class="nx">ivar</span><span class="p">(</span><span class="s">&#39;env&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="nx">$</span><span class="p">.</span><span class="nx">NSMutableDictionary</span> <span class="s">&#39;dictionary&#39;</span>
  <span class="nv">args = </span><span class="nx">self</span><span class="p">.</span><span class="nx">ivar</span><span class="p">(</span><span class="s">&#39;args&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="nx">$</span><span class="p">.</span><span class="nx">NSMutableArray</span> <span class="s">&#39;arrayWithCapacity&#39;</span><span class="p">,</span> <span class="mi">0</span>
  <span class="nv">err = </span><span class="nx">self</span><span class="p">.</span><span class="nx">ivar</span><span class="p">(</span><span class="s">&#39;err&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="nx">$</span> <span class="s">&#39;/tmp/iosctrl.err&#39;</span>
  <span class="nv">out = </span><span class="nx">self</span><span class="p">.</span><span class="nx">ivar</span><span class="p">(</span><span class="s">&#39;out&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="nx">$</span> <span class="s">&#39;/tmp/iosctrl.out&#39;</span>
  <span class="nv">fam = </span><span class="nx">$</span> <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">ivar</span><span class="p">(</span><span class="s">&#39;family&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="s">&#39;&#39;</span><span class="p">).</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">is</span> <span class="s">&#39;ipad&#39;</span> <span class="k">then</span> <span class="mi">2</span> <span class="k">else</span> <span class="mi">1</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Create the simulator configuration.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">config = </span><span class="nx">$</span><span class="p">.</span><span class="nx">DTiPhoneSimulatorSessionConfig</span><span class="p">(</span><span class="s">&#39;alloc&#39;</span><span class="p">)(</span><span class="s">&#39;init&#39;</span><span class="p">)</span> <span class="s">&#39;autorelease&#39;</span>
  <span class="nx">config</span> <span class="s">&#39;setApplicationToSimulateOnStart&#39;</span><span class="p">,</span> <span class="nx">app</span>
  <span class="nx">config</span> <span class="s">&#39;setSimulatedSystemRoot&#39;</span><span class="p">,</span> <span class="nx">sys</span>
  <span class="nx">config</span> <span class="s">&#39;setSimulatedApplicationShouldWaitForDebugger&#39;</span><span class="p">,</span> <span class="mi">0</span>
  <span class="nx">config</span> <span class="s">&#39;setSimulatedApplicationLaunchArgs&#39;</span><span class="p">,</span> <span class="nx">args</span>
  <span class="nx">config</span> <span class="s">&#39;setSimulatedApplicationLaunchEnvironment&#39;</span><span class="p">,</span> <span class="nx">env</span>
  <span class="nx">config</span> <span class="s">&#39;setSimulatedApplicationStdErrPath&#39;</span><span class="p">,</span> <span class="nx">err</span>
  <span class="nx">config</span> <span class="s">&#39;setSimulatedApplicationStdOutPath&#39;</span><span class="p">,</span> <span class="nx">out</span>
  <span class="nx">config</span> <span class="s">&#39;setLocalizedClientName&#39;</span><span class="p">,</span> <span class="nx">$</span> <span class="s">&#39;iosctrl&#39;</span>
  <span class="nx">config</span> <span class="s">&#39;setSimulatedDeviceFamily&#39;</span><span class="p">,</span> <span class="nx">fam</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Create the simulator session and attach a delegate instance.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">session = </span><span class="nx">$</span><span class="p">.</span><span class="nx">DTiPhoneSimulatorSession</span><span class="p">(</span><span class="s">&#39;alloc&#39;</span><span class="p">)(</span><span class="s">&#39;init&#39;</span><span class="p">)</span> <span class="s">&#39;autorelease&#39;</span>
  <span class="nx">session</span> <span class="s">&#39;setDelegate&#39;</span><span class="p">,</span> <span class="nx">self</span>
  <span class="nx">self</span><span class="p">.</span><span class="nx">ivar</span> <span class="s">&#39;session&#39;</span><span class="p">,</span> <span class="nx">session</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Start the simulator session.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">err = </span><span class="nx">$</span><span class="p">.</span><span class="nx">NSError</span><span class="p">.</span><span class="nx">createPointer</span><span class="p">()</span>
  <span class="k">if</span> <span class="nx">session</span> <span class="s">&#39;requestStartWithConfig&#39;</span><span class="p">,</span> <span class="nx">config</span><span class="p">,</span> <span class="s">&#39;timeout&#39;</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="s">&#39;error&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">ref</span><span class="p">()</span>
    <span class="nx">debug</span> <span class="s">&#39;start requested&#39;</span>
    <span class="nx">process</span><span class="p">.</span><span class="nx">send</span> <span class="s">&#39;starting&#39;</span> <span class="k">if</span> <span class="nx">process</span><span class="p">.</span><span class="nx">send</span>
  <span class="k">else</span>
    <span class="nx">debug</span> <span class="s">&#39;start request failed&#39;</span>
    <span class="nx">process</span><span class="p">.</span><span class="nx">send</span> <span class="s">&#39;ended&#39;</span> <span class="k">if</span> <span class="nx">process</span><span class="p">.</span><span class="nx">send</span>
    </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Add the <code>started</code> callback method to the Session class.</p></div></div><div class="code"><div class="wrapper"><span class="nx">Session</span><span class="p">.</span><span class="nx">addMethod</span> <span class="s">&#39;session:didStart:withError:&#39;</span><span class="p">,</span> <span class="s">&#39;v@:@c@&#39;</span><span class="p">,</span>
  <span class="nf">(self, sel, sess, did, err) -&gt;</span>
    <span class="k">if</span> <span class="nx">did</span>
      <span class="nx">debug</span> <span class="s">&#39;started&#39;</span>
      <span class="nx">process</span><span class="p">.</span><span class="nx">send</span> <span class="s">&#39;started&#39;</span> <span class="k">if</span> <span class="nx">process</span><span class="p">.</span><span class="nx">send</span>
    <span class="k">else</span>
      <span class="nx">debug</span> <span class="s">&#39;start did not start&#39;</span><span class="p">,</span> <span class="nx">err</span>
      <span class="nx">process</span><span class="p">.</span><span class="nx">send</span> <span class="s">&#39;ended&#39;</span> <span class="k">if</span> <span class="nx">process</span><span class="p">.</span><span class="nx">send</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Add the <code>ended</code> callback method to the Session class.</p></div></div><div class="code"><div class="wrapper"><span class="nx">Session</span><span class="p">.</span><span class="nx">addMethod</span> <span class="s">&#39;session:didEndWithError:&#39;</span><span class="p">,</span> <span class="s">&#39;v@:@@&#39;</span><span class="p">,</span> <span class="nf">(self, sel, sess, err) -&gt;</span>
  <span class="nx">debug</span> <span class="s">&#39;ended&#39;</span><span class="p">,</span> <span class="nx">err</span>
  <span class="nx">process</span><span class="p">.</span><span class="nx">send</span> <span class="s">&#39;ended&#39;</span> <span class="k">if</span> <span class="nx">process</span><span class="p">.</span><span class="nx">send</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Register the Session class with the ObjC bridge.</p></div></div><div class="code"><div class="wrapper"><span class="nx">Session</span><span class="p">.</span><span class="nx">register</span><span class="p">()</span></div></div></div></div></body></html>